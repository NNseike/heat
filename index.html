<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語タイピング練習</title>
    <style>
        /* 白を基調としたシンプルなUIデザイン */
        body {
            font-family: 'Segoe UI', Meiryo, 'Hiragino Kaku Gothic ProN', 'MS PGothic', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        p {
            text-align: center;
            color: #666;
            margin-top: 0;
            margin-bottom: 30px;
        }

        /* --- Chapter Selection Styles --- */
        #selection-container h1 {
            margin-bottom: 20px;
        }
        #chapter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .chapter-btn {
            padding: 12px 20px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            flex-grow: 1;
            min-width: 150px;
        }
        .chapter-btn:hover {
            background-color: #0056b3;
        }
        .chapter-btn.all {
            background-color: #28a745;
            width: 100%;
        }
        .chapter-btn.all:hover {
            background-color: #218838;
        }

        /* --- Game Styles --- */
        #game-container {
            display: none; /* Initially hidden */
        }
        #character-display {
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
            margin-bottom: 15px;
            height: 25px;
            text-align: center;
        }
        #japanese-display {
            font-size: 1.4em;
            color: #222;
            margin-bottom: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }
        #typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            background-color: #fff;
            border: 1px solid #ccc;
            color: #333;
            border-radius: 4px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.1s, box-shadow 0.1s;
        }
        #typing-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }
        #typing-input.correct {
            border-color: #28a745;
            background-color: #f0fff4;
        }
        #typing-input.incorrect-flash {
            border-color: #dc3545;
        }
        #answer-display {
            margin-top: 15px;
            font-size: 1.2em;
            color: #555;
            min-height: 50px;
            text-align: center;
            padding: 10px;
            line-height: 1.6;
        }
        /* --- Explanation Styles --- */
        .explanation {
            font-size: 0.95em;
            color: #444;
            text-align: left;
            margin-top: 15px;
            padding: 12px;
            background-color: #fcfcfc;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            line-height: 1.7;
        }
        .explanation strong {
            color: #0056b3;
        }
        #progress-container {
            margin-top: 20px;
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 10px;
            background-color: #007bff;
            transition: width 0.5s;
        }
        .restart-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            background-color: #6c757d;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .restart-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <div id="selection-container" class="container">
        <h1>英語タイピング練習</h1>
        <p>学習したいチャプターを選択してください。</p>
        <div id="chapter-buttons">
            <!-- Buttons will be generated here by JavaScript -->
        </div>
    </div>

    <div id="game-container" class="container">
        <p style="font-size:0.9em; margin-bottom: 20px;">正解すると自動で次の問題に進みます。文法のヒントが必要な場合はいつでもEnterキーを押してください。</p>

        <div id="character-display"></div>
        <div id="japanese-display"></div>
        
        <input type="text" id="typing-input" placeholder="ここに英語で入力..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        
        <div id="answer-display"></div>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <script>
        // --- DATA with explanations ---
        const fullScript = [
            { char: 'SPEAKER A', en: 'Seven years in Folsom.', ja: 'フォルサムに7年。', explanation: '<strong>文法</strong>: 主語と動詞（例: I spent）が省略された、話し言葉でよく使われる表現です。<br><strong>単語</strong>: <strong>Folsom</strong> - カリフォルニア州にある有名な「フォルサム州立刑務所」のこと。' },
            { char: 'SPEAKER A', en: 'In the hole for three.', ja: 'うち3年は独房だ。', explanation: '<strong>文法</strong>: これも文の断片です。「(I was) in the hole for three (years)」のように補完できます。<br><strong>イディオム</strong>: <strong>in the hole</strong> - 刑務所のスラングで「独房に入れられている」という意味です。' },
            { char: 'SPEAKER A', en: 'McNeil before that.', ja: 'その前はマクニール。', explanation: '<strong>文法</strong>: 「(I was at) McNeil before that.」が省略された形です。<br><strong>単語</strong>: <strong>McNeil</strong> - ここでは「マクニール島刑務所」を指しています。' },
            { char: 'SPEAKER A', en: 'McNeil as tough as they say?', ja: 'マクニールは噂通りきつかったか？', explanation: '<strong>文法</strong>: 「Is McNeil as tough as they say?」の「Is」が省略された疑問文です。<br><strong>表現</strong>: <strong>as tough as they say</strong> - 「噂されているのと同じくらい厳しい」という意味の比較表現。' },
            { char: 'SPEAKER B', en: 'You looking to become a penologist?', ja: '刑務所の専門家になりたいのか？', explanation: '<strong>文法</strong>: 「Are you looking to...?」の「Are」が省略された形。「be looking to do」で「～しようと考えている、～するつもりだ」という意味。<br><strong>単語</strong>: <strong>penologist</strong> - 刑務所管理や犯罪者の更生を研究する「刑罰学者」。' },
            { char: 'SPEAKER A', en: 'You’re looking to go back?', ja: '戻りたいのか？', explanation: '<strong>文法</strong>: 本来は疑問文ですが、平叙文の語順のまま語尾を上げて質問する口語的な表現です。「Are you looking to go back?」と同じ意味になります。' },
            { char: 'SPEAKER A', en: 'You know, I chase down some crews…', ja: '私が追っているチームの中には…', explanation: '<strong>表現</strong>: <strong>You know</strong> - 文頭で「あのさ」「ご存知の通り」のように、相手の注意を引いたり、話を切り出す時に使われる口癖のような言葉です。<br><strong>単語</strong>: <strong>chase down</strong> - 「追い詰める、追いかける」。<strong>crews</strong> - ここでは「犯罪者のチーム、一味」を指します。' },
            { char: 'SPEAKER A', en: 'guys just looking to fuck up, get busted back.', ja: 'ただ失敗して、また捕まりたいだけの者もいる。', explanation: '<strong>構文</strong>: 前の文の`crews`を説明する部分です。「(They are) guys just looking to...」となっています。<br><strong>単語</strong>: <strong>fuck up</strong> - 「しくじる、大失敗する」という強いスラング。<strong>get busted</strong> - 「逮捕される」というスラング。' },
            { char: 'SPEAKER A', en: 'That you?', ja: '君もそうか？', explanation: '<strong>文法</strong>: 「Is that you?」のIsが省略された形。ここでは「その(しくじりたがっている)タイプは君か？」というニュアンスです。' },
            { char: 'SPEAKER B', en: 'You must’ve worked some dipshit crews.', ja: 'ずいぶんと未熟なチームを相手にしてきたんだな。', explanation: '<strong>文法</strong>: <strong>must’ve worked</strong> は「must have worked」の短縮形。「～したに違いない」という過去への強い推量を表します。<br><strong>単語</strong>: <strong>dipshit</strong> - 「間抜けな、バカな」という意味の非常に強いスラング。' },
            { char: 'SPEAKER A', en: 'I worked all kinds.', ja: 'あらゆる種類を相手にしてきた。', explanation: '<strong>表現</strong>: 「I worked with all kinds of crews.」の後半が省略された形。<strong>all kinds</strong>だけで「あらゆる種類の（もの、人々）」という意味になります。' },
            { char: 'SPEAKER B', en: 'You see me doing thrill-seeking liquor-store holdups…', ja: '私がスリルを求めて酒店の強盗でもするように見えるか？', explanation: '<strong>文法</strong>: <strong>see O doing</strong> - 「Oが～しているのを見る/見える」という構文。ここでは「私(me)が～している(doing)ように見えるか？」と反語的に使っています。<br><strong>単語</strong>: <strong>thrill-seeking</strong> - 「スリルを求める」。<strong>holdup</strong> - 「強盗」。' },
            { char: 'SPEAKER B', en: 'with a “Born to Lose” tattoo on my chest?', ja: '胸に「負け犬」の刺青を入れているとでも？', explanation: '<strong>表現</strong>: 前の文からの続きです。「...holdups with a tattoo...?」と繋がっています。<br><strong>Born to Lose</strong> - 「負けるために生まれてきた」という意味で、自暴自棄な人が好むフレーズ。' },
            { char: 'SPEAKER A', en: 'No, I do not.', ja: 'いや、見えない。', explanation: '<strong>文法</strong>: 「No, I don’t see you doing that.」を丁寧かつ強調して言った形。単に「No, I don’t.」と言うよりも、`do not`とすることで否定が強調されます。' },
            { char: 'SPEAKER B', en: 'Right. I am never going back.', ja: 'その通り。二度と戻るつもりはない。', explanation: '<strong>文法</strong>: <strong>be going to</strong>は未来の予定を表しますが、<strong>never</strong>と共に使うことで「決して～するつもりはない」という非常に強い意志を表します。' },
            { char: 'SPEAKER A', en: 'Then don’t take down scores.', ja: 'ならば、仕事はするな。', explanation: '<strong>文法</strong>: <strong>Don’t ...</strong> - 命令文の否定形。「～するな」という意味。<br><strong>イディオム</strong>: <strong>take down a score</strong> - 犯罪スラングで「大きなヤマ（仕事）をやる、強盗を成功させる」という意味です。' },
            { char: 'SPEAKER B', en: 'I do what I do best, I take scores.', ja: '私は得意なことをする。それが仕事だ。', explanation: '<strong>構文</strong>: <strong>what I do best</strong> - 「私が最も得意とすること」という意味の関係代名詞節です。' },
            { char: 'SPEAKER B', en: 'You do what you do best, trying to stop guys like me.', ja: 'あなたも得意なことをする。俺みたいな奴らを止めようとする。', explanation: '<strong>構文</strong>: ここでの<strong>trying to...</strong>は、前の文「You do what you do best」を補足説明する分詞構文です。「そして（それは）～しようとすることだ」というニュアンス。' },
            { char: 'SPEAKER A', en: 'So you never wanted a regular-type life?', ja: 'では、普通の生活を望んだことはないのか？', explanation: '<strong>表現</strong>: <strong>regular-type life</strong> - 「普通のタイプの生活」。-typeを付けることで「～な種類の」というニュアンスを加えています。口語的な表現です。' },
            { char: 'SPEAKER B', en: 'What the fuck is that? Barbecues and ball games?', ja: 'それは一体何だ？バーベキューと野球観戦か？', explanation: '<strong>表現</strong>: <strong>What the fuck is ...?</strong> - 「一体全体～は何だ？」と、驚きや苛立ち、軽蔑を強調する非常に強いスラング表現です。' },
            { char: 'SPEAKER A', en: 'Yeah.', ja: 'ああ。', explanation: '<strong>単語</strong>: <strong>Yeah</strong> - 「Yes」のカジュアルな言い方。ここでは相手の言った「バーベキューと野球観戦」という例を肯定しています。' },
            { char: 'SPEAKER B', en: 'This regular-type life like your life?', ja: 'その普通の生活とは、あなたの人生のようなものか？', explanation: '<strong>文法</strong>: 「Is this regular-type life like your life?」のIsが省略された疑問文。<strong>like your life</strong>で「あなたの人生のような」という意味。' },
            { char: 'SPEAKER A', en: 'My life? No, my life… No, my life’s a disaster zone.', ja: '私の人生か？いや、私の人生は…災害地帯のようなものだ。', explanation: '<strong>文法</strong>: <strong>my life’s</strong>は「my life is」の短縮形。<br><strong>表現</strong>: <strong>a disaster zone</strong> - 「災害地帯」。自分の人生がめちゃくちゃで手に負えない状態であることを比喩的に表現しています。' },
            { char: 'SPEAKER A', en: 'I got a stepdaughter so fucked up… because her real father is this large-type asshole.', ja: '義理の娘がいるが、実の父親がひどい男で、彼女は問題を抱えている。', explanation: '<strong>単語</strong>: <strong>stepdaughter</strong> - 継娘（妻の連れ子）。<strong>fucked up</strong> - 「めちゃくちゃな状態の、精神的に参っている」という強いスラング。<strong>asshole</strong> - 「嫌なやつ、クソ野郎」という意味の非常に強いスラング。' },
            { char: 'SPEAKER A', en: 'I got a wife. We’re passing each other on the down slope of a marriage… my third…', ja: '妻もいる。結婚生活の下降線をたどっている…これで3度目だ…', explanation: '<strong>表現</strong>: <strong>passing each other on the down slope of a marriage</strong> - 「結婚生活の下り坂ですれ違っている」という詩的な比喩。夫婦関係が冷え切っていることを示します。<br><strong>my third</strong> - 「(this is) my third (marriage)」の略。' },
            { char: 'SPEAKER A', en: 'because I spend all my time chasing guys like you around the block.', ja: 'なぜなら、全ての時間を君のような人間を追いかけるのに費やしているからだ。', explanation: '<strong>構文</strong>: <strong>spend time V-ing</strong> - 「～して時間を費やす」という定番の形。ここでは`chasing`が使われています。<br><strong>around the block</strong> - 「近所を、あたりを」。' },
            { char: 'SPEAKER A', en: 'That’s my life.', ja: 'それが私の人生だ。', explanation: '<strong>文法</strong>: <strong>That’s</strong>は「That is」の短縮形。前に述べた全ての状況を指して「それが私の人生だ」と要約しています。' },
            { char: 'SPEAKER B', en: 'A guy told me one time: “Don’t let yourself get attached to anything…', ja: '昔、ある男に言われた。「何にも執着するな…」', explanation: '<strong>文法</strong>: <strong>let O C</strong> - 「OにCさせる」。ここでは「自分自身(yourself)が執着する(get attached)状態にさせるな」という意味。<br><strong>表現</strong>: <strong>get attached to</strong> - 「～に愛着を持つ、執着する」。' },
            { char: 'SPEAKER B', en: 'you are not willing to walk out on in 30 seconds flat…', ja: '「30秒で捨て去る覚悟ができていないものには…」', explanation: '<strong>構文</strong>: 前の文の`anything`を修飾しています。「(anything that) you are not willing to...」という関係代名詞が省略されています。<br><strong>表現</strong>: <strong>be willing to do</strong> - 「～するのを厭わない、～する覚悟がある」。<strong>walk out on</strong> - 「（人や場所）を見捨てる、置き去りにする」。<strong>30 seconds flat</strong> - 「30秒きっかりで」。' },
            { char: 'SPEAKER B', en: 'if you feel the heat around the corner.”', ja: '「もし角の向こうに危険を感じたらな。」', explanation: '<strong>表現</strong>: <strong>feel the heat</strong> - スラングで「警察のプレッシャーを感じる、危険が迫っているのを感じる」という意味。<br><strong>around the corner</strong> - 「すぐ近くに、角を曲がった所に」。' },
            { char: 'SPEAKER B', en: 'Now, if you’re on me, and you gotta move when I move…', ja: 'さて、あなたが私を追っていて、私が動く時にあなたも動かなければならないとしたら…', explanation: '<strong>表現</strong>: <strong>be on me</strong> - ここでは「私を追跡している、監視している」という意味。<br><strong>文法</strong>: <strong>gotta</strong> - 「have got to」の略で、「～しなければならない」という意味の口語表現。' },
            { char: 'SPEAKER B', en: 'how do you expect to keep a marriage?', ja: 'どうやって結婚生活を維持するつもりだ？', explanation: '<strong>文法</strong>: <strong>expect to do</strong> - 「～するつもりである、～できると思う」。ここでは「どうやって結婚生活を維持するつもりなんだ？（できるはずがないだろう）」という反語的なニュアンスが含まれています。' },
            { char: 'SPEAKER A', en: 'Well, that’s an interesting point.', ja: 'なるほど、興味深い点だ。', explanation: '<strong>表現</strong>: 相手の意見に感心したり、一理あると認めたりする際の丁寧な言い方です。' },
            { char: 'SPEAKER A', en: 'What are you, a monk?', ja: '君は、まるで修道僧だな？', explanation: '<strong>表現</strong>: <strong>What are you, a ...?</strong> - 「一体君は何なんだ、...なのか？」と、相手の生き方や考え方を何かに例えて質問する表現。ここでは、執着を捨てる生き方が「修道僧(monk)」のようだと言っています。' },
            { char: 'SPEAKER B', en: 'I have a woman.', ja: '女性がいる。', explanation: '<strong>文法</strong>: シンプルな現在形。ここでは、恋人やパートナーがいるという事実を述べています。' },
            { char: 'SPEAKER A', en: 'What do you tell her?', ja: '彼女には何と説明している？', explanation: '<strong>文法</strong>: 現在形の疑問文。習慣的に行っていること、つまり普段彼女に何と説明しているかを尋ねています。' },
            { char: 'SPEAKER B', en: 'I tell her I’m a salesman.', ja: 'セールスマンだと。', explanation: '<strong>文法</strong>: tell O [that] S V - 「OにSがVだと告げる」という構文。thatは省略されています。' },
            { char: 'SPEAKER A', en: 'So then, if you spot me coming around that corner…', ja: 'では、もし君が角の向こうに私を見つけたら…', explanation: '<strong>文法</strong>: <strong>spot O V-ing</strong> - 「Oが～しているのを見つける」。`see`や`watch`と同じ知覚動詞の構文です。<br><strong>単語</strong>: <strong>spot</strong> - 「見つける、発見する」。' },
            { char: 'SPEAKER A', en: 'you’re just gonna walk out on this woman?', ja: 'その女性を置き去りにするのか？', explanation: '<strong>文法</strong>: <strong>gonna</strong> - 「going to」の口語表現。平叙文の形で、語尾を上げて疑問を表しています。' },
            { char: 'SPEAKER A', en: 'Not say goodbye?', ja: 'さよならも言わずに？', explanation: '<strong>文法</strong>: 「Are you not going to say goodbye?」が極端に省略された形。' },
            { char: 'SPEAKER B', en: 'That’s the discipline.', ja: 'それが規律だ。', explanation: '<strong>単語</strong>: <strong>discipline</strong> - 「規律、自制心」。自分の行動規範やルールであることを示しています。' },
            { char: 'SPEAKER A', en: 'That’s pretty vacant, no?', ja: 'それはかなり空虚じゃないか？', explanation: '<strong>単語</strong>: <strong>vacant</strong> - 「空っぽの、空虚な」。感情や人間味がないという意味で使われています。<br><strong>表現</strong>: <strong>, no?</strong> - 文末に付けて「～じゃないか？」と相手の同意を求める口語表現。' },
            { char: 'SPEAKER B', 'en': 'Yeah, it is what it is.', ja: 'ああ、そういうものだ。', explanation: '<strong>イディオム</strong>: <strong>it is what it is</strong> - 「それが現実だ」「仕方がない」「そういうものだ」という意味。変えられない状況を受け入れる際に使う決まり文句です。' },
            { char: 'SPEAKER B', en: 'It’s that, or we both better go do something else, pal.', ja: 'そうするか、さもなければ、お互い別のことをした方がいい。', explanation: '<strong>文法</strong>: <strong>had better do</strong> - 「～した方がよい」。`had`が省略されて`better do`となることが口語では非常に多いです。<br><strong>単語</strong>: <strong>pal</strong> - 「仲間、友達」。' },
            { char: 'SPEAKER A', en: 'I don’t know how to do anything else.', ja: '私には他に何もできない。', explanation: '<strong>構文</strong>: <strong>how to do</strong> - 「～のやり方、～する方法」。`know`の目的語になっています。' },
            { char: 'SPEAKER B', en: 'Neither do I.', ja: '私もだ。', explanation: '<strong>文法</strong>: 前の否定文（I don’t know...）を受けて、「私も～ない」と同意する際の決まった表現です。「Me neither.」よりも少し丁寧で強調した言い方になります。' },
            { char: 'SPEAKER A', en: 'I don’t much want to either.', ja: 'あまりそうしたいとも思わない。', explanation: '<strong>文法</strong>: <strong>not much</strong> - 「あまり～ない」。<strong>want to</strong>の後には`do anything else`が省略されています。<br><strong>either</strong> - 否定文の最後につけて「～もまた（...ない）」という意味。' },
            { char: 'SPEAKER B', en: 'Neither do I.', ja: '私もだ。', explanation: '<strong>文法</strong>: 前の否定文（I don’t much want to...）を受けて、「私も～ない」と同意する表現です。' },
            { char: 'SPEAKER A', en: 'You know, I have this, uh, recurring dream.', ja: '私には、繰り返し見る夢があるんだ。', explanation: '<strong>単語</strong>: <strong>recurring</strong> - 「繰り返し起こる、再発する」。<strong>recurring dream</strong>で「繰り返し見る夢」となります。' },
            { char: 'SPEAKER A', en: 'I’m sitting at this big banquet table…', ja: '大きな晩餐会のテーブルに座っている…', explanation: '<strong>文法</strong>: 現在進行形 (be V-ing) を使うことで、夢の内容を生き生きと、臨場感を持って描写しています。' },
            { char: 'SPEAKER A', en: 'and all the victims of all the murders I ever worked are sitting at this table', ja: '私が今まで扱った事件の犠牲者が全員そのテーブルに座っている。', explanation: '<strong>構文</strong>: <strong>the murders (that) I ever worked</strong> - `murders`と`I`の間に関係代名詞`that`が省略されています。「私がこれまでに担当した殺人事件」という意味。' },
            { char: 'SPEAKER A', en: 'and they’re staring at me with these black eyeballs…', ja: 'そして彼らは、黒くなった眼で私をじっと見つめている…', explanation: '<strong>単語</strong>: <strong>stare at</strong> - 「～をじっと見つめる、凝視する」。<br><strong>eyeballs</strong> - 「眼球」。`eyes`よりも生々しい、物理的な響きがあります。' },
            { char: 'SPEAKER A', en: 'because they got eight-ball hemorrhages from the head wounds.', ja: '頭の傷からの出血でそうなったんだ。', explanation: '<strong>単語</strong>: <strong>eight-ball hemorrhage</strong> - 殴打などによる頭部外傷で眼の周りにできる、ビリヤードの8番ボールのような黒い皮下出血のこと。専門的な警察用語です。' },
            { char: 'SPEAKER A', en: 'And there they are, these big balloon people…', ja: 'そこに彼らはいる、大きく膨らんだ人々が…', explanation: '<strong>表現</strong>: <strong>There they are</strong> - 「ほら、彼らがいる」と、目の前にいるかのように指し示す表現。<br><strong>balloon people</strong> - 遺体が腐敗してガスで膨れ上がった状態を「風船人間」と比喩しています。' },
            { char: 'SPEAKER A', en: 'because I found them two weeks after they’d been under the bed.', ja: 'ベッドの下で2週間経ってから私が見つけたからだ。', explanation: '<strong>文法</strong>: <strong>they’d been</strong> - 「they had been」の短縮形。私が見つけた(found)過去の時点よりも、さらに前の過去（大過去）からずっとベッドの下にいたことを示すため、過去完了形が使われています。' },
            { char: 'SPEAKER A', en: 'The neighbors reported the smell… and there they are, all of them just sitting there.', ja: '近所の人が異臭を報告して…そして彼らは、そこにただ座っている。', explanation: '<strong>構文</strong>: <strong>all of them just sitting there</strong> - 分詞構文の一種で、`and they are all just sitting there`のように、生き生きとした描写をするために使われます。' },
            { char: 'SPEAKER B', en: 'What do they say?', ja: '彼らは何を言う？', explanation: '<strong>文法</strong>: 現在形を使うことで、夢の中でいつも「彼ら」が習慣的に何を言うのかを尋ねています。' },
            { char: 'SPEAKER A', en: 'Nothing.', ja: '何も言わない。', explanation: '<strong>文法</strong>: 「They say nothing.」の目的語だけを答える、会話的な省略表現です。' },
            { char: 'SPEAKER B', en: 'No talk?', ja: '話さないのか？', explanation: '<strong>文法</strong>: 「Is there no talk?」や「They don’t talk?」が極端に省略された形。' },
            { char: 'SPEAKER A', en: 'None. Just… They don’t have anything to say.', ja: '全く。ただ…彼らは何も言うことがないんだ。', explanation: '<strong>単語</strong>: <strong>None</strong> - 「全くない」。`Nothing`とほぼ同じ意味で、前の`No talk?`に対する返事です。<br><strong>表現</strong>: <strong>have anything to say</strong> - 「言うべきことがある」。否定文なので`anything`が使われています。' },
            { char: 'SPEAKER A', en: 'See, we just look at each other. They look at me.', ja: '私たちはただ見つめ合う。彼らが私を見る。', explanation: '<strong>表現</strong>: <strong>See</strong> - 文頭で「ほら」「いいかい」のように相手に理解を促す時に使います。<br><strong>look at each other</strong> - 「お互いを見る」。' },
            { char: 'SPEAKER A', en: 'And that’s it, that’s the dream.', ja: 'それだけだ、それが夢の内容だ。', explanation: '<strong>表現</strong>: <strong>That’s it.</strong> - 「それで全部だ、それだけだ」と物事を締めくくる時の決まり文句です。' },
            { char: 'SPEAKER B', en: 'I have one where I’m drowning.', ja: '私は溺れる夢を見る。', explanation: '<strong>構文</strong>: <strong>one where S+V</strong> - ここでの`one`は`a dream`を指しています。`where`は関係副詞で「SがVする（夢）」と、前の名詞を説明します。' },
            { char: 'SPEAKER B', en: 'And I gotta wake myself up and start breathing, or I’ll die in my sleep.', ja: 'そして自分で目を覚まして呼吸を始めなければ、眠ったまま死んでしまう。', explanation: '<strong>文法</strong>: <strong>gotta</strong> - 「have got to」の略で「～しなければならない」。<br><strong>wake (oneself) up</strong> - 「目を覚ます」。<br><strong>or</strong> - ここでは「さもないと、そうしないと」という意味の命令文や義務の文脈で使われます。' },
            { char: 'SPEAKER A', en: 'You know what that’s about?', ja: 'それが何を意味するか分かるか？', explanation: '<strong>構文</strong>: <strong>what that’s about</strong> - 間接疑問文。「それが何についてのものか」という意味の塊が`know`の目的語になっています。' },
            { char: 'SPEAKER B', en: 'Yeah. Having enough time.', ja: 'ああ。十分な時間を持つことだ。', explanation: '<strong>文法</strong>: 「It’s about having enough time.」の主語と動詞が省略された形。動名詞`having`が使われています。' },
            { char: 'SPEAKER A', en: 'Enough time to do what you wanna do?', ja: 'やりたいことをするのに十分な時間か？', explanation: '<strong>構文</strong>: <strong>time to do</strong> - 「～するための時間」という不定詞の形容詞的用法。<br><strong>what you wanna do</strong> - 「君がしたいこと」という関係代名詞節。<strong>wanna</strong>は`want to`の口語表現。' },
            { char: 'SPEAKER B', en: 'That’s right.', ja: 'その通りだ。', explanation: '<strong>表現</strong>: 相手の言ったことが正しいと強く肯定する際の決まり文句です。' },
            { char: 'SPEAKER A', en: 'You doing it now?', ja: '今、それをやっているのか？', explanation: '<strong>文法</strong>: 「Are you doing it now?」の`Are`が省略された、非常に口語的な疑問文です。' },
            { char: 'SPEAKER B', en: 'No, not yet.', ja: 'いや、まだだ。', explanation: '<strong>表現</strong>: 「まだ～していない」と答える際の定番の返事です。' },
            { char: 'SPEAKER A', en: 'You know, we’re sitting here… you and I, like a couple of regular fellows.', ja: '私たちはここに座っている…君と私、まるで普通の仲間のように。', explanation: '<strong>表現</strong>: <strong>like a couple of regular fellows</strong> - 「二人の普通の仲間のように」。`like`は「～のように」という前置詞。`fellows`は`guys`に似た「男たち、連中」という言葉。' },
            { char: 'SPEAKER A', en: 'You do what you do, and I do what I gotta do.', ja: '君は君のやるべきことをやり、私は私のやるべきことをやる。', explanation: '<strong>構文</strong>: <strong>what you do</strong>「君がすること」、<strong>what I gotta do</strong>「私がやらなければならないこと」。<br>対照的な構造で、それぞれの立場を表現しています。' },
            { char: 'SPEAKER A', en: 'And now that we’ve been face to face…', ja: 'そして今、私たちは顔を合わせた…', explanation: '<strong>表現</strong>: <strong>now that S+V</strong> - 「今やSがVなので、～だからには」。状況が変化したことを示す接続詞。<br><strong>face to face</strong> - 「直接顔を合わせて」。' },
            { char: 'SPEAKER A', en: 'if I’m there and I gotta put you away, I won’t like it.', ja: 'もし私がそこにいて、君を捕まえなければならなくなっても、それは本意ではない。', explanation: '<strong>単語</strong>: <strong>put you away</strong> - ここでは「刑務所に入れる、捕まえる」という意味のスラング。<br><strong>won’t</strong> - `will not`の短縮形。「～しないだろう、～するつもりはない」。' },
            { char: 'SPEAKER A', en: 'But I’ll tell you… if it’s between you and some poor bastard…', ja: 'だが言っておく…もしそれが君と、ある哀れな男との間なら…', explanation: '<strong>表現</strong>: <strong>if it’s between A and B</strong> - 「もしAとBのどちらかを選ばなければならない状況なら」。<br><strong>単語</strong>: <strong>bastard</strong> - 「ろくでなし、哀れなやつ」。元々は侮辱語ですが、同情的に使われることもあります。' },
            { char: 'SPEAKER A', en: 'whose wife you’re gonna turn into a widow… brother, you are going down.', ja: '君がその妻を未亡人にするっていうなら…兄弟、お前は終わりだ。', explanation: '<strong>文法</strong>: <strong>whose wife</strong> - `some poor bastard`を説明する関係代名詞。「その男の妻を～」。<br><strong>表現</strong>: <strong>go down</strong> - スラングで「負ける、捕まる、殺される」など、敗北や破滅を表します。' },
            { char: 'SPEAKER B', en: 'There’s a flip side to that coin.', ja: 'そのコインには裏側もある。', explanation: '<strong>イディオム</strong>: <strong>There’s a flip side to that coin.</strong> - 「物事には裏側（別の側面）もある」という意味の決まり文句。' },
            { char: 'SPEAKER B', en: 'What if you do got me boxed in and I gotta put you down?', ja: 'もしあなたが私を追い詰めて、私があなたを倒さなければならなくなったらどうする？', explanation: '<strong>表現</strong>: <strong>What if ...?</strong> - 「もし～だったらどうする？」と仮定の状況を提示する表現。<br><strong>box in</strong> - 「追い詰める、閉じ込める」。<br><strong>put you down</strong> - 「殺す、始末する」という意味の非常に強い表現。' },
            { char: 'SPEAKER B', en: 'Because no matter what, you will not get in my way.', ja: 'なぜなら、何があろうと、あなたは私の邪魔はできない。', explanation: '<strong>表現</strong>: <strong>no matter what</strong> - 「何が起ころうとも、どんなことがあっても」。<br><strong>get in my way</strong> - 「私の邪魔をする」。' },
            { char: 'SPEAKER B', en: 'We’ve been face to face, yeah… but I will not hesitate.', ja: '私たちは顔を合わせた、そう…だが私はためらわない。', explanation: '<strong>文法</strong>: <strong>will not</strong> - `won’t`を使わずに言うことで、「ためらわない」という強い意志を強調しています。<br><strong>単語</strong>: <strong>hesitate</strong> - 「ためらう、躊躇する」。' },
            { char: 'SPEAKER B', en: 'Not for a second.', ja: '一瞬たりともな。', explanation: '<strong>表現</strong>: 「I will not hesitate for a second.」の後半部分だけを強調して言った形。「一瞬たりとも（ためらわない）」という意味。' },
            { char: 'SPEAKER A', en: 'Maybe that’s the way it’ll be.', ja: 'たぶん、そうなるだろう。', explanation: '<strong>表現</strong>: <strong>the way it’ll be</strong> - 「それがそうなるであろう方法・様子」、つまり「物事の成り行き」。運命を受け入れるようなニュアンスです。<br><strong>it’ll</strong> - `it will`の短縮形。' },
            { char: 'SPEAKER A', en: 'Or who knows?', ja: 'あるいは、どうなるか誰にも分からない。', explanation: '<strong>表現</strong>: <strong>Who knows?</strong> - 「誰が知っているだろうか？（いや、誰も知らない）」という意味の反語表現。未来が不確かであることを示す決まり文句です。' },
            { char: 'SPEAKER B', en: 'Or maybe we’ll never see each other again.', ja: 'あるいは、もう二度と会うことはないかもしれない。', explanation: '<strong>文法</strong>: <strong>we’ll</strong> - `we will`の短縮形。`never`を使うことで「決して～ないだろう」という未来の否定を表します。' }
        ];

        // --- Global State ---
        let activeScript = [];
        let currentLineIndex = 0;
        const CHAPTER_SIZE = 5;

        // --- DOM Elements ---
        const selectionContainer = document.getElementById('selection-container');
        const gameContainer = document.getElementById('game-container');
        const chapterButtonsContainer = document.getElementById('chapter-buttons');
        const characterDisplay = document.getElementById('character-display');
        const japaneseDisplay = document.getElementById('japanese-display');
        const typingInput = document.getElementById('typing-input');
        const answerDisplay = document.getElementById('answer-display');
        const progressBar = document.getElementById('progress-bar');
        
        // --- Core Game Logic ---
        function setupLine() {
            if (currentLineIndex >= activeScript.length) {
                showEndScreen();
                return;
            }
            const currentLine = activeScript[currentLineIndex];
            characterDisplay.textContent = currentLine.char;
            japaneseDisplay.textContent = currentLine.ja;
            typingInput.value = '';
            typingInput.className = '';
            typingInput.disabled = false;
            typingInput.focus();
            answerDisplay.textContent = '';
            updateProgressBar();
        }
        
        function updateProgressBar() {
            const progress = ((currentLineIndex + 1) / activeScript.length) * 100;
            progressBar.style.width = progress + '%';
        }
        
        function handleInput() {
            if (typingInput.disabled) return;
            const currentLine = activeScript[currentLineIndex];
            const correctAnswer = currentLine.en;
            const userInput = typingInput.value;
            
            if (correctAnswer.startsWith(userInput)) {
                typingInput.classList.remove('incorrect-flash');
                if (userInput === correctAnswer) {
                    typingInput.classList.add('correct');
                    answerDisplay.innerHTML = `<strong style="color: #28a745;">正解！</strong>`;
                    typingInput.disabled = true;
                    updateProgressBar();
                    setTimeout(() => nextLine(), 800);
                }
            } else {
                typingInput.value = userInput.slice(0, -1);
                typingInput.classList.add('incorrect-flash');
                setTimeout(() => typingInput.classList.remove('incorrect-flash'), 200);
            }
        }

        function nextLine() {
            currentLineIndex++;
            setupLine();
        }

        function startGame(selectedScript) {
            activeScript = selectedScript;
            currentLineIndex = 0;
            selectionContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            setupLine();
        }
        
        // --- Screen Management ---
        function showEndScreen() {
            characterDisplay.textContent = '完了';
            japaneseDisplay.textContent = '選択した範囲の練習が終了しました。お疲れ様でした。';
            typingInput.style.display = 'none';
            answerDisplay.textContent = '';
            
            const existingButton = gameContainer.querySelector('.restart-button');
            if (!existingButton) {
                const restartButton = document.createElement('button');
                restartButton.textContent = 'チャプター選択に戻る';
                restartButton.className = 'restart-button';
                restartButton.onclick = () => showSelectionScreen();
                gameContainer.appendChild(restartButton);
            }
        }

        function showSelectionScreen() {
            gameContainer.style.display = 'none';
            selectionContainer.style.display = 'block';
            const restartButton = gameContainer.querySelector('.restart-button');
            if (restartButton) {
                restartButton.remove();
            }
            typingInput.style.display = 'block';
        }

        function createChapterSelection() {
            const allBtn = document.createElement('button');
            allBtn.textContent = `All Questions (${fullScript.length})`;
            allBtn.className = 'chapter-btn all';
            allBtn.onclick = () => startGame(fullScript);
            chapterButtonsContainer.appendChild(allBtn);
            
            for (let i = 0; i < fullScript.length; i += CHAPTER_SIZE) {
                const chapter = fullScript.slice(i, i + CHAPTER_SIZE);
                const chapterNum = (i / CHAPTER_SIZE) + 1;
                
                const chapterBtn = document.createElement('button');
                chapterBtn.textContent = `Chapter ${chapterNum}`;
                chapterBtn.className = 'chapter-btn';
                chapterBtn.onclick = () => startGame(chapter);
                chapterButtonsContainer.appendChild(chapterBtn);
            }
        }

        // --- Event Listeners ---
        typingInput.addEventListener('input', handleInput);

        typingInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                if (gameContainer.style.display !== 'block' || typingInput.disabled) return;
                
                const currentLine = activeScript[currentLineIndex];
                const correctAnswer = currentLine.en;
                const explanation = currentLine.explanation;
                
                answerDisplay.innerHTML = `正解: <strong style="color: #007bff;">${correctAnswer}</strong>
                                           <div class="explanation">${explanation}</div>`;
            }
        });
        
        // --- Initializer ---
        window.onload = () => {
            createChapterSelection();
        };

    </script>
</body>
</html>
